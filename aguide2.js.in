function main()
{
    init_page(true);
    add_bookmarklet();

    let params = new URLSearchParams(window.location.search);
    let guideEnc = params.get("guide");
    let aguide_text = params.get("aguide_text");
    let storage_name_enc = params.get("storage");
    if(guideEnc) {
        let guide = decodeURI(guideEnc);
        console.log("guide = " + guide);
        if(guide.indexOf("http") === 0 || guide.indexOf("file") === 0) {
            let xhr = new XMLHttpRequest();
            xhr.open("GET", guide);
            xhr.responseType = "blob";
            xhr.onload = async () => {
                const text = await xhr.response.text();
                process_input(text);
            };
            xhr.send();
        }
    } else if(aguide_text) {
        process_input(decodeURI(aguide_text), "");
    } else if(storage_name_enc) {
        const storage_name = decodeURI(storage_name_enc);
        // const text = window.localStorage.getItem(storage_name);
        browser.runtime.sendMessage({method: "getGuideText"}, function(resp) {
            const text = resp.text;
            if(!text || text === "") {
                console.log("Couldn't read local storage name = " + storage_name);
                return;
            } else {
                console.log("got local storage: " + text);
            }
            process_input(text, "");
        });
    } else {
        const inputElement = document.getElementById("open-file");
        inputElement.addEventListener("change", read_input, false);
        inputElement.click();
    }
}

function add_bookmarklet()
{
    let toolbar_e = document.getElementById("toolbar");
    let span_e = document.createElement("span");
    span_e.className = "bookmarklet";
    let a_e = document.createElement("a");
    const aguide_js = `
let ag_text = document.firstChild.textContent;
__INCLUDE__({{{aguide_escaped.js}}});
init_page(false)
;
process_input(ag_text, "");
`;
    a_e.href = "javascript:" + aguide_js;
    a_e.innerHTML = "Bookmarklet";
    span_e.append(a_e);
    toolbar_e.append(span_e);
}

__INCLUDE__({{{aguide.js}}})

main();
